<% layout("/layouts/boilerplate") %>

    <div class="container mt-5">
        <h2 class="text-center mb-4">Listing Moderation</h2>

        <% if(listings.length === 0){ %>
            <div class="alert alert-success text-center">
                No pending listings
            </div>
            <% } %>

                <div class="row">

                    <% listings.forEach(l => { %>
                        <div class="col-md-4">
                            <div class="card mb-4 shadow">

                                <!-- SAFE IMAGE -->
                                <%
                    let img = "https://images.unsplash.com/photo-1566073771259-6a8506099945";
                    if(l && l.image){
                        if(typeof l.image === "string"){
                            img = l.image;
                        }else if(l.image.url){
                            img = l.image.url;
                        }
                    }
                    %>

                                    <img src="<%= img %>" class="card-img-top" style="height:200px; object-fit:cover;">

                                    <div class="card-body">

                                        <h5>
                                            <%= l.title %>
                                        </h5>

                                        <p>
                                            <%= l.location %>,
                                                <%= l.country %>
                                        </p>

                                        <!-- SAFE MAP -->
                                        <% if(l && l.geometry && l.geometry.lat){ %>
                                            <div id="map-<%= l._id %>" class="admin-map mb-3"></div>
                                            <% } else { %>
                                                <p class="text-muted">Location map not available</p>
                                                <% } %>

                                                    <!-- SAFE OWNER -->
                                                    <p><b>Host:</b>
                                                        <% if(l.owner && l.owner.email){ %>
                                                            <%= l.owner.email %>
                                                                <% } else { %>
                                                                    <span class="text-danger">Host Account Deleted</span>
                                                                    <% } %>
                                                    </p>

                                                    <p><b>Price:</b> â‚¹
                                                        <%= l.price %> / night</p>
                                                    <p><b>Guest Capacity:</b>
                                                        <%= l.capacity %> guests</p>
                                                    <p><b>Description:</b>
                                                        <%= l.description %>
                                                    </p>

                                                    <div class="d-flex gap-2">

                                                        <form action="/admin/approve/<%= l._id %>?_method=PUT" method="POST">
                                                            <button class="btn btn-success w-100">Approve</button>
                                                        </form>

                                                        <form action="/admin/reject/<%= l._id %>?_method=PUT" method="POST">
                                                            <button class="btn btn-danger w-100">Reject</button>
                                                        </form>

                                                    </div>

                                    </div>
                            </div>
                        </div>
                        <% }) %>

                </div>

                <!-- Leaflet -->
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
                <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

                <script>
                    document.addEventListener("DOMContentLoaded", function() {

                        const listings = JSON.parse('<%- JSON.stringify(listings || []) %>');

                        listings.forEach(l => {

                            if (!l || !l.geometry || !l.geometry.lat) return;

                            const mapId = "map-" + l._id;

                            const map = L.map(mapId).setView(
                                [l.geometry.lat, l.geometry.lng],
                                13
                            );

                            L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
                                attribution: "&copy; OpenStreetMap contributors"
                            }).addTo(map);

                            L.marker([l.geometry.lat, l.geometry.lng])
                                .addTo(map)
                                .bindPopup("<b>" + l.title + "</b><br>" + l.location)
                                .openPopup();
                        });
                    });
                </script>

                <style>
                    .admin-map {
                        height: 250px;
                        width: 100%;
                        border-radius: 10px;
                        border: 1px solid #ddd;
                    }
                </style>

    </div>